<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.toyo.fish.data.wrapper.mail.persistence.MailMapper">
  <resultMap id="BaseResultMap" type="com.toyo.fish.data.wrapper.mail.domain.Mail">
    <!--
      WARNING - @mbggenerated
      This element is automatically generated by MyBatis Generator, do not modify.
    -->
    <id column="id" jdbcType="BIGINT" property="id" />
    <result column="title" jdbcType="VARCHAR" property="title" />
    <result column="sender" jdbcType="BIGINT" property="sender" />
    <result column="content" jdbcType="VARCHAR" property="content" />
    <result column="category" jdbcType="INTEGER" property="category" />
    <result column="attachment_state" jdbcType="INTEGER" property="attachmentState" />
    <result column="attachments" jdbcType="VARCHAR" property="attachments" />
    <result column="time_trigger_expression" jdbcType="VARCHAR" property="timeTriggerExpression" />
    <result column="active_hours" jdbcType="INTEGER" property="activeHours" />
    <result column="trigger_expression" jdbcType="VARCHAR" property="triggerExpression" />
    <result column="filter_state" jdbcType="INTEGER" property="filterState" />
    <result column="cleanup_state" jdbcType="INTEGER" property="cleanupState" />
    <result column="update_time" jdbcType="TIMESTAMP" property="updateTime" />
    <result column="create_time" jdbcType="TIMESTAMP" property="createTime" />
     <result column="reciever" jdbcType="BIGINT" property="reciever" />
     <result column="in_queue_state" jdbcType="INTEGER" property="inQueueState" />
  </resultMap>
  <sql id="Base_Column_List">
    <!--
      WARNING - @mbggenerated
      This element is automatically generated by MyBatis Generator, do not modify.
    -->
    id, title, sender, content, category, attachment_state, attachments, time_trigger_expression, 
    active_hours, trigger_expression, filter_state, cleanup_state, update_time, create_time,reciever,in_queue_state
  </sql>
  <select id="selectByPrimaryKey" parameterType="java.lang.Long" resultMap="BaseResultMap">
    <!--
      WARNING - @mbggenerated
      This element is automatically generated by MyBatis Generator, do not modify.
    -->
    select 
    <include refid="Base_Column_List" />
    from ty_mail
    where id = #{id,jdbcType=BIGINT}
  </select>
  <delete id="deleteByPrimaryKey" parameterType="java.lang.Long">
    <!--
      WARNING - @mbggenerated
      This element is automatically generated by MyBatis Generator, do not modify.
    -->
    delete from ty_mail
    where id = #{id,jdbcType=BIGINT}
  </delete>
  <insert id="insert" parameterType="com.toyo.fish.data.wrapper.mail.domain.Mail"
   useGeneratedKeys="true" keyProperty="id"
  >
    <!--
      WARNING - @mbggenerated
      This element is automatically generated by MyBatis Generator, do not modify.
    -->
    insert into ty_mail (id, title, sender, 
      content, category, attachment_state, 
      attachments, time_trigger_expression, active_hours, 
      trigger_expression, filter_state, cleanup_state, 
      update_time, create_time,reciever,in_queue_state)
    values (#{id,jdbcType=BIGINT}, #{title,jdbcType=VARCHAR}, #{sender,jdbcType=BIGINT}, 
      #{content,jdbcType=VARCHAR}, #{category,jdbcType=INTEGER}, #{attachmentState,jdbcType=INTEGER}, 
      #{attachments,jdbcType=VARCHAR}, #{timeTriggerExpression,jdbcType=VARCHAR}, #{activeHours,jdbcType=INTEGER}, 
      #{triggerExpression,jdbcType=VARCHAR}, #{filterState,jdbcType=INTEGER}, #{cleanupState,jdbcType=INTEGER}, 
      #{updateTime,jdbcType=TIMESTAMP}, #{createTime,jdbcType=TIMESTAMP},#{reciever,jdbcType=BIGINT},#{inQueueState,jdbcType=INTEGER})
  </insert>
  <insert id="insertSelective" parameterType="com.toyo.fish.data.wrapper.mail.domain.Mail"
  
   useGeneratedKeys="true" keyProperty="id"
  >
    <!--
      WARNING - @mbggenerated
      This element is automatically generated by MyBatis Generator, do not modify.
    -->
    insert into ty_mail
    <trim prefix="(" suffix=")" suffixOverrides=",">
      <if test="id != null">
        id,
      </if>
      <if test="title != null">
        title,
      </if>
      <if test="sender != null">
        sender,
      </if>
      <if test="content != null">
        content,
      </if>
      <if test="category != null">
        category,
      </if>
      <if test="attachmentState != null">
        attachment_state,
      </if>
      <if test="attachments != null">
        attachments,
      </if>
      <if test="timeTriggerExpression != null">
        time_trigger_expression,
      </if>
      <if test="activeHours != null">
        active_hours,
      </if>
      <if test="triggerExpression != null">
        trigger_expression,
      </if>
      <if test="filterState != null">
        filter_state,
      </if>
      <if test="cleanupState != null">
        cleanup_state,
      </if>
      <if test="updateTime != null">
        update_time,
      </if>
      <if test="createTime != null">
        create_time,
      </if>
      
       <if test="reciever != null">
        reciever,
      </if>
       <if test="inQueueState != null">
        in_queue_state,
      </if>
    </trim>
    <trim prefix="values (" suffix=")" suffixOverrides=",">
      <if test="id != null">
        #{id,jdbcType=BIGINT},
      </if>
      <if test="title != null">
        #{title,jdbcType=VARCHAR},
      </if>
      <if test="sender != null">
        #{sender,jdbcType=BIGINT},
      </if>
      <if test="content != null">
        #{content,jdbcType=VARCHAR},
      </if>
      <if test="category != null">
        #{category,jdbcType=INTEGER},
      </if>
      <if test="attachmentState != null">
        #{attachmentState,jdbcType=INTEGER},
      </if>
      <if test="attachments != null">
        #{attachments,jdbcType=VARCHAR},
      </if>
      <if test="timeTriggerExpression != null">
        #{timeTriggerExpression,jdbcType=VARCHAR},
      </if>
      <if test="activeHours != null">
        #{activeHours,jdbcType=INTEGER},
      </if>
      <if test="triggerExpression != null">
        #{triggerExpression,jdbcType=VARCHAR},
      </if>
      <if test="filterState != null">
        #{filterState,jdbcType=INTEGER},
      </if>
      <if test="cleanupState != null">
        #{cleanupState,jdbcType=INTEGER},
      </if>
      <if test="updateTime != null">
        #{updateTime,jdbcType=TIMESTAMP},
      </if>
      <if test="createTime != null">
        #{createTime,jdbcType=TIMESTAMP},
      </if>
       <if test="reciever != null">
        #{reciever,jdbcType=BIGINT},
      </if>
       <if test="inQueueState != null">
        #{inQueueState,jdbcType=INTEGER},
      </if>
    </trim>
  </insert>
  <update id="updateByPrimaryKeySelective" parameterType="com.toyo.fish.data.wrapper.mail.domain.Mail">
    <!--
      WARNING - @mbggenerated
      This element is automatically generated by MyBatis Generator, do not modify.
    -->
    update ty_mail
    <set>
      <if test="title != null">
        title = #{title,jdbcType=VARCHAR},
      </if>
      <if test="sender != null">
        sender = #{sender,jdbcType=BIGINT},
      </if>
      <if test="content != null">
        content = #{content,jdbcType=VARCHAR},
      </if>
      <if test="category != null">
        category = #{category,jdbcType=INTEGER},
      </if>
      <if test="attachmentState != null">
        attachment_state = #{attachmentState,jdbcType=INTEGER},
      </if>
      <if test="attachments != null">
        attachments = #{attachments,jdbcType=VARCHAR},
      </if>
      <if test="timeTriggerExpression != null">
        time_trigger_expression = #{timeTriggerExpression,jdbcType=VARCHAR},
      </if>
      <if test="activeHours != null">
        active_hours = #{activeHours,jdbcType=INTEGER},
      </if>
      <if test="triggerExpression != null">
        trigger_expression = #{triggerExpression,jdbcType=VARCHAR},
      </if>
      <if test="filterState != null">
        filter_state = #{filterState,jdbcType=INTEGER},
      </if>
      <if test="cleanupState != null">
        cleanup_state = #{cleanupState,jdbcType=INTEGER},
      </if>
      <if test="updateTime != null">
        update_time = #{updateTime,jdbcType=TIMESTAMP},
      </if>
      <if test="createTime != null">
        create_time = #{createTime,jdbcType=TIMESTAMP},
      </if>
       <if test="inQueueState != null">
        in_queue_state=#{inQueueState,jdbcType=INTEGER},
      </if>
       <if test="reciever != null">
        reciever=#{reciever,jdbcType=BIGINT},
      </if>
    </set>
    where id = #{id,jdbcType=BIGINT}
  </update>
  <update id="updateByPrimaryKey" parameterType="com.toyo.fish.data.wrapper.mail.domain.Mail">
    <!--
      WARNING - @mbggenerated
      This element is automatically generated by MyBatis Generator, do not modify.
    -->
    update ty_mail
    set title = #{title,jdbcType=VARCHAR},
      sender = #{sender,jdbcType=BIGINT},
      content = #{content,jdbcType=VARCHAR},
      category = #{category,jdbcType=INTEGER},
      attachment_state = #{attachmentState,jdbcType=INTEGER},
      attachments = #{attachments,jdbcType=VARCHAR},
      time_trigger_expression = #{timeTriggerExpression,jdbcType=VARCHAR},
      active_hours = #{activeHours,jdbcType=INTEGER},
      trigger_expression = #{triggerExpression,jdbcType=VARCHAR},
      filter_state = #{filterState,jdbcType=INTEGER},
      cleanup_state = #{cleanupState,jdbcType=INTEGER},
      update_time = #{updateTime,jdbcType=TIMESTAMP},
      create_time = #{createTime,jdbcType=TIMESTAMP},
       reciever=#{reciever,jdbcType=BIGINT},
        in_queue_state=#{inQueueState,jdbcType=INTEGER}
    where id = #{id,jdbcType=BIGINT}
  </update>
  
  
  
  <update id="updateTriggerActive" >
    <!--
      WARNING - @mbggenerated
      This element is automatically generated by MyBatis Generator, do not modify.
    -->
    update ty_mail
    set 
      filter_state = 1
    where 
     filter_state=0 and category!=4 and
     date_format(current_timestamp(),"%Y-%m-%d %H:%i:%s") 
     between time_trigger_expression  and  date_add(time_trigger_expression,interval active_hours MINUTE)
 		   
  </update>
  
  <update id="updateTriggerExpired" >
    <!--
      WARNING - @mbggenerated
      This element is automatically generated by MyBatis Generator, do not modify.
    -->
    update ty_mail
    set 
      filter_state = 2
    where 
     filter_state=1 and 
  	 current_timestamp()  &gt;  date_add(time_trigger_expression,interval active_hours minute)
 		  
  </update>
  
  
  <update id="updateTriggerCleanedup" >
    <!--
      WARNING - @mbggenerated
      This element is automatically generated by MyBatis Generator, do not modify.
    -->
    update ty_mail
    set 
      filter_state = 3
    where 
     filter_state=2 and 
     
      <if test="mailIdeSeq == null">
      1=2
      </if>
     <if test="mailIdeSeq != null">
     id in 
      <foreach collection="mailIdeSeq" item="item" index="index"   separator=","   open="("  close=")"> 
     		${item}
   	</foreach>
    	 
    </if>
  			  
  </update>
  
  
   <!--
      WARNING - @mbggenerated
      This element is automatically generated by MyBatis Generator, do not modify.
    -->
  <update id="updateIdInQueue" >
   
    update ty_mail
    set 
      in_queue_state = 1
    where 
     in_queue_state=0 and 
     
      <if test="mailIdeSeq == null">
      1=2
      </if>
     <if test="mailIdeSeq != null">
     id in 
      <foreach collection="mailIdeSeq" item="item" index="index"   separator=","   open="("  close=")"> 
     		${item}
   	</foreach>
    	 
    </if>
  			  
  </update>
  
  
   <update id="updateIdInQueueClear" >
   
    update ty_mail
    set 
      in_queue_state = 0 where in_queue_state=1
   
  			  
  </update>
  
  
    <!--
      WARNING - @mbggenerated
      This element is automatically generated by MyBatis Generator, do not modify.
    -->
   <select id="sizeOfActiveExpression"   resultType="java.lang.Integer">
   
    select 
    count(1) 
    from ty_mail
    where filter_state=1  
  </select>
  
   
   <select id="selectActiveExpressionNotInQueue"   resultMap="BaseResultMap">
    <!--
      WARNING - @mbggenerated
      This element is automatically generated by MyBatis Generator, do not modify.
    -->
    select 
       <include refid="Base_Column_List" />
    from ty_mail
    where filter_state=1 and in_queue_state=0 order by create_time
  </select>
  
  
   <select id="selectByFilterState" resultType="java.lang.Long">
    <!--
      WARNING - @mbggenerated
      This element is automatically generated by MyBatis Generator, do not modify.
    -->
    select 
    id
    from ty_mail
    where filter_state=#{state}	order by create_time desc  limit 0,500 
  </select>
  
  
  
  <select id="selectActiveFriendRequestMail" resultMap="BaseResultMap">
    <!--
      WARNING - @mbggenerated
      This element is automatically generated by MyBatis Generator, do not modify.
    -->
    select 
    <include refid="Base_Column_List" />
    from ty_mail
    where filter_state in (0,1) and sender=#{userId} and category=2  
  </select>
  
  
   <!--
      WARNING - @mbggenerated
      This element is automatically generated by MyBatis Generator, do not modify.
    -->
    <select id="sizeOfActiveFriendRequestMail" resultType="java.lang.Integer">
   
    select 
    count(1) as cnt
    from ty_mail
    where filter_state in (0,1) and sender=#{userId} and reciever=#{friendId} and category=2  
  </select>
  
  
  <delete id="deleteByIdSeq" >
  
    delete from ty_mail
    where  
     <if test="mailIdSeq == null">
      1=2
     </if>
     <if test="mailIdSeq != null">
     id in 
      <foreach collection="mailIdSeq" item="item" index="index"   separator=","   open="("  close=")"> 
     		${item}
   	</foreach>
   	</if>
  </delete>
  
  
   <delete id="deleteActiveFriendMailLogBySender" >
  
  delete l from ty_mail_trigger_log l ,
    (
    select id from ty_mail
    where  
   	sender=#{userId}  and category in (2,3)
     and
     <if test="friendIdSeq == null">
      1=2
     </if>
     <if test="friendIdSeq != null">
     reciever in 
      <foreach collection="friendIdSeq" item="item" index="index"   separator=","   open="("  close=")"> 
     		${item}
   	</foreach>
   	</if>
   	) m 
   	where l.mail_id=l.id;
  </delete>
  
  
   <delete id="deleteActiveFriendMailBySender" >
  
    delete from ty_mail
    where  
   	sender=#{userId}  and category in (2,3)
     and
     <if test="friendIdSeq == null">
      1=2
     </if>
     <if test="friendIdSeq != null">
     reciever in 
      <foreach collection="friendIdSeq" item="item" index="index"   separator=","   open="("  close=")"> 
     		${item}
   	</foreach>
   	</if>
  </delete>
  
  
   <delete id="deleteActiveFriendMailLogByReciever" >
  
    delete l from ty_mail_trigger_log l ,
    (
    select id from ty_mail
    where  
   	sender=#{userId}  and category in (2,3)
     and
     <if test="friendIdSeq == null">
      1=2
     </if>
     <if test="friendIdSeq != null">
     reciever in 
      <foreach collection="friendIdSeq" item="item" index="index"   separator=","   open="("  close=")"> 
     		${item}
   	</foreach>
   	</if>
   	) m 
   	where l.mail_id=l.id;
  </delete>
  
  
  <delete id="deleteActiveFriendMailByReciever" >
  
    delete from ty_mail
    where  
   	sender=#{userId}  and category in (2,3)
     and
     <if test="friendIdSeq == null">
      1=2
     </if>
     <if test="friendIdSeq != null">
     reciever in 
      <foreach collection="friendIdSeq" item="item" index="index"   separator=","   open="("  close=")"> 
     		${item}
   	</foreach>
   	</if>
  </delete>
  
  
  <delete id="deleteBySenderOrRecieverId" >
   delete from ty_mail
    where   sender=#{userId} or reciever=#{userId}
  </delete>
 
</mapper>